{% extends "base.html" %}

{% block title %}Dashboard - DockerLabs{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <div class="welcome-section">
            <h1>Dashboard</h1>
            <p class="welcome-text">Bienvenido de nuevo, <span class="username">{{ session.get('username') }}</span></p>
        </div>

        <div class="dashboard-actions">
            <button type="button" class="btn-claim-machine" onclick="openClaimMachineModal()">
                <i class="bi bi-flag"></i>
                Reclamar Autoría Máquina
            </button>
        </div>
    </div>

    <div class="dashboard-content">

        <div class="profile-section">
            <div class="section-header">
                <h2><i class="bi bi-person-circle"></i> Perfil de Usuario</h2>
            </div>

            <div class="profile-content">
                <div class="profile-picture-section">
                    <div class="profile-picture-container">
                        <img src="{{ profile_image_url }}" alt="Foto de perfil" class="profile-picture"
                            id="profilePicture">
                        <div class="profile-picture-overlay">
                            <button class="change-photo-btn" onclick="document.getElementById('photoInput').click()">
                                <i class="bi bi-camera"></i>
                            </button>
                        </div>
                    </div>
                    <input type="file" id="photoInput" accept="image/*" style="display: none;"
                        onchange="handlePhotoUpload(event)">
                    <p class="photo-help-text">Haz clic en la cámara para cambiar tu foto de perfil</p>

                    <div class="social-links-section mt-4">
                        <h5 style="font-size: 0.9rem; margin-bottom: 12px; color: var(--text-primary);">
                            <i class="bi bi-link-45deg"></i> Redes Sociales
                        </h5>
                        <div class="form-group mb-2">
                            <label for="linkedin_url" style="font-size: 0.85rem;">
                                <i class="bi bi-linkedin" style="color: #0077B5;"></i> LinkedIn
                            </label>
                            <input type="url" id="linkedin_url" class="form-control form-control-sm"
                                placeholder="https://linkedin.com/in/tu-perfil"
                                value="{{ (user.linkedin_url or '') | e }}">
                        </div>
                        <div class="form-group mb-2">
                            <label for="github_url" style="font-size: 0.85rem;">
                                <i class="bi bi-github" style="color: #333;"></i> GitHub
                            </label>
                            <input type="url" id="github_url" class="form-control form-control-sm"
                                placeholder="https://github.com/tu-usuario" value="{{ (user.github_url or '') | e }}">
                        </div>
                        <div class="form-group mb-2">
                            <label for="youtube_url" style="font-size: 0.85rem;">
                                <i class="bi bi-youtube" style="color: #FF0000;"></i> YouTube
                            </label>
                            <input type="url" id="youtube_url" class="form-control form-control-sm"
                                placeholder="https://youtube.com/@tu-canal" value="{{ (user.youtube_url or '') | e }}">
                        </div>
                    </div>
                </div>

                <div class="profile-info-section">
                    <form class="profile-form">
                        <div class="form-group">
                            <label for="username"><i class="bi bi-person"></i> Nombre de usuario</label>
                            <div class="profile-display-field">{{ session.get('username') }}</div>
                        </div>

                        <div class="form-group">
                            <label for="email"><i class="bi bi-envelope"></i> Correo electrónico</label>
                            <div class="profile-display-field">{{ user.email or 'No especificado' }}</div>
                        </div>

                        <div class="form-group">
                            <label for="bio"><i class="bi bi-card-text"></i> Biografía</label>
                            <textarea id="bio" class="form-control" rows="3"
                                placeholder="Cuéntanos algo sobre ti...">{{ user.biography or '' }}</textarea>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn-save" onclick="saveProfile()">
                                <i class="bi bi-check-circle"></i> Guardar cambios
                            </button>
                            <button type="button" class="btn-cancel" onclick="cancelEdit()">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </button>
                        </div>

                        <div class="form-group mt-4">
                            <label for="requested_username"><i class="bi bi-person"></i> Solicitar cambio de nombre de
                                usuario</label>
                            <div class="d-flex gap-2 align-items-center">
                                <input type="text" id="requested_username" class="form-control"
                                    placeholder="Nuevo nombre deseado" minlength="3" maxlength="20">
                                <button type="button" class="btn btn-warning" onclick="openUsernameChangeModal()">
                                    <i class="bi bi-send"></i> Solicitar
                                </button>
                            </div>
                            <small class="text-muted">La solicitud será revisada por un admin o moderador.</small>
                        </div>

                    </form>
                </div>
            </div>
        </div>

        <div class="security-section">
            <div class="section-header">
                <h2><i class="bi bi-shield-lock"></i> Seguridad</h2>
            </div>

            <div class="security-content">
                <form class="security-form">
                    <div class="form-group">
                        <label for="currentPassword"><i class="bi bi-key"></i> Contraseña Actual</label>
                        <input type="password" id="currentPassword" class="form-control"
                            placeholder="Ingresa tu contraseña actual">
                    </div>

                    <div class="form-group">
                        <label for="newPassword"><i class="bi bi-key-fill"></i> Nueva Contraseña</label>
                        <input type="password" id="newPassword" class="form-control"
                            placeholder="Ingirma tu nueva contraseña">
                        <div class="password-strength">
                            <span class="strength-label">Fortaleza:</span>
                            <div class="strength-bar">
                                <div class="strength-indicator" id="passwordStrength"></div>
                            </div>
                            <span class="strength-text" id="strengthText">Débil</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="confirmPassword"><i class="bi bi-key-fill"></i> Confirmar Contraseña</label>
                        <input type="password" id="confirmPassword" class="form-control"
                            placeholder="Confirma tu nueva contraseña">
                    </div>

                    <div class="password-requirements">
                        <h4>Requisitos de la contraseña:</h4>
                        <ul>
                            <li class="requirement"><i class="bi bi-dash-circle"></i> Mínimo 8 caracteres</li>
                            <li class="requirement"><i class="bi bi-dash-circle"></i> Al menos una mayúscula</li>
                            <li class="requirement"><i class="bi bi-dash-circle"></i> Al menos un número</li>
                            <li class="requirement"><i class="bi bi-dash-circle"></i> Al menos un carácter especial</li>
                        </ul>
                    </div>

                    <div class="form-actions">
                        <button type="button" id="btnChangePassword" class="btn-save">
                            <i class="bi bi-shield-check"></i> Actualizar contraseña
                        </button>
                        <button type="reset" class="btn-cancel">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        {% if current_user_role in ['admin', 'moderador'] and claims %}
        <div class="claims-section">
            <div class="section-header">
                <h2><i class="bi bi-flag"></i> Reclamaciones de autoría de máquinas</h2>
            </div>
            <div class="claims-list">
                {% for c in claims %}
                <div class="claim-card">
                    <div class="claim-header d-flex justify-content-between align-items-center">
                        <span class="claim-machine"><i class="bi bi-cpu"></i> {{ c.maquina_nombre }}</span>
                        <span class="claim-status badge bg-warning text-dark text-uppercase">{{ c.estado }}</span>
                    </div>
                    <div class="claim-body">
                        <p><strong>Usuario:</strong> {{ c.username }}</p>
                        <p><strong>Contacto:</strong> {{ c.contacto | e }}</p>
                        <p><strong>Prueba aportada:</strong></p>
                        <p class="claim-proof">{{ c.prueba | e }}</p>
                        <p class="claim-date"><small>Recibida: {{ c.created_at }}</small></p>

                        {% if current_user_role == 'admin' and c.estado == 'pendiente' %}
                        <div class="claim-actions d-flex gap-2 mt-2">
                            <form method="post" action="{{ url_for('maquinas.approve_claim', claim_id=c.id) }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-sm btn-success">
                                    <i class="bi bi-check-circle"></i> Aprobar
                                </button>
                            </form>
                            <form method="post" action="{{ url_for('maquinas.reject_claim', claim_id=c.id) }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-sm btn-danger">
                                    <i class="bi bi-x-circle"></i> Rechazar
                                </button>
                            </form>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

    </div>
</div>

<div id="usernameChangeModal" class="claim-modal" style="display:none;">
    <div class="claim-modal-dialog">
        <button type="button" class="modal-close-button" onclick="closeUsernameChangeModal()">&times;</button>
        <h3>Solicitar cambio de nombre de usuario</h3>
        <form method="POST" action="{{ url_for('auth.request_username_change') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="form-group">
                <label for="requested_username_input">Nuevo nombre</label>
                <input id="requested_username_input" name="requested_username" class="form-control" required
                    minlength="3" maxlength="20">
            </div>

            <div class="form-group mt-3">
                <label for="reason">Motivo (opcional)</label>
                <textarea id="reason" name="reason" class="form-control" rows="3"></textarea>
            </div>

            <div class="form-group mt-3">
                <label for="contacto_opcional">Correo o usuario de Telegram/Discord (opcional)</label>
                <input id="contacto_opcional" name="contacto_opcional" class="form-control"
                    placeholder="Ejemplo: usuario@correo.com / @usuario">
            </div>

            <div class="form-actions d-flex justify-content-end gap-2 mt-4">
                <button type="button" class="btn btn-secondary" onclick="closeUsernameChangeModal()">Cancelar</button>
                <button type="submit" class="btn btn-primary">Enviar solicitud</button>
            </div>
        </form>
    </div>
</div>

<div id="claimMachineModal" class="claim-modal">
    <div class="claim-modal-dialog">
        <button type="button" class="modal-close-button" onclick="closeClaimMachineModal()">&times;</button>
        <h2>Reclamar Autoría de Máquina</h2>
        <p class="modal-description">
            Selecciona la máquina que quieres reclamar y proporciona tus datos de contacto y una prueba de que esa
            máquina es tuya.
        </p>
        <form method="post" action="{{ url_for('maquinas.reclamar_maquina') }}" class="claim-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="form-group mb-3">
                <label for="maquina_nombre"><i class="bi bi-cpu"></i> Máquina</label>
                <select id="maquina_nombre" name="maquina_nombre" class="form-control" required>
                    <option value="" disabled selected>Selecciona una máquina</option>
                    {% for m in maquinas %}
                    <option value="{{ m.nombre }}">{{ m.nombre }} (autor actual: {{ m.autor }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group mb-3">
                <label for="contacto"><i class="bi bi-envelope"></i> Datos de contacto</label>
                <input type="text" id="contacto" name="contacto" class="form-control"
                    placeholder="Correo, usuario de Telegram, etc." required>
            </div>
            <div class="form-group mb-3">
                <label for="prueba"><i class="bi bi-clipboard-check"></i> Prueba de autoría</label>
                <textarea id="prueba" name="prueba" class="form-control" rows="4"
                    placeholder="Incluye enlaces, capturas, referencias, etc." required></textarea>
            </div>
            <div class="form-actions d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-secondary" onclick="closeClaimMachineModal()">Cancelar</button>
                <button type="submit" class="btn btn-primary">Enviar reclamación</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script>
    function openUsernameChangeModal() {
        const val = document.getElementById('requested_username').value;
        document.getElementById('requested_username_input').value = val || "";
        document.getElementById('usernameChangeModal').style.display = 'block';
    }
    function closeUsernameChangeModal() {
        document.getElementById('usernameChangeModal').style.display = 'none';
    }
</script>
{% endblock %}