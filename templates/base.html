<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}DockerLabs{% endblock %}</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta name="csrf-token" content="{{ csrf_token() }}">

    {% if not no_default_styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <!-- Messaging CSS -->
    <style>
        .msg-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.7rem;
            display: none;
        }

        .msg-btn {
            position: relative;
        }

        /* Messaging Modal Styles */
        #messagingModal .modal-body {
            padding: 0;
            display: flex;
            height: 500px;
            overflow: hidden;
            background: #1e293b;
        }

        .msg-sidebar {
            width: 35%;
            border-right: 1px solid #334155;
            display: flex;
            flex-direction: column;
            background: #0f172a;
        }

        .msg-content {
            width: 65%;
            display: flex;
            flex-direction: column;
            background: #1e293b;
        }

        .msg-list {
            overflow-y: auto;
            flex: 1;
        }

        .msg-contact {
            padding: 1rem;
            border-bottom: 1px solid #334155;
            cursor: pointer;
            transition: background 0.2s;
        }

        .msg-contact:hover,
        .msg-contact.active {
            background: #334155;
        }

        .msg-contact .name {
            font-weight: bold;
            color: #f8fafc;
            display: block;
        }

        .msg-contact .last-msg {
            color: #94a3b8;
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .msg-chat-header {
            padding: 1rem;
            border-bottom: 1px solid #334155;
            background: #0f172a;
            color: #f8fafc;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .msg-chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .msg-message {
            max-width: 80%;
            padding: 0.5rem 1rem;
            border-radius: 12px;
            font-size: 0.95rem;
            word-wrap: break-word;
        }

        .msg-message.sent {
            align-self: flex-end;
            background: #3b82f6;
            color: white;
            border-bottom-right-radius: 2px;
        }

        .msg-message.received {
            align-self: flex-start;
            background: #334155;
            color: #f8fafc;
            border-bottom-left-radius: 2px;
        }

        .msg-input-area {
            padding: 1rem;
            border-top: 1px solid #334155;
            background: #0f172a;
            display: flex;
            gap: 0.5rem;
        }

        .msg-input {
            flex: 1;
            background: #1e293b;
            border: 1px solid #334155;
            color: white;
            padding: 0.5rem;
            border-radius: 6px;
        }

        .msg-send-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
        }

        .msg-new-btn {
            margin: 1rem;
            width: calc(100% - 2rem);
            background: #3b82f6;
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: 6px;
        }

        /* Mobile handling */
        @media (max-width: 768px) {
            #messagingModal .modal-body {
                flex-direction: column;
            }

            .msg-sidebar {
                width: 100%;
                height: 100%;
                border-right: none;
            }

            .msg-content {
                width: 100%;
                height: 100%;
                display: none;
            }

            .msg-content.active {
                display: flex;
            }

            .msg-sidebar.hidden {
                display: none;
            }

            .msg-back-btn {
                display: inline-block !important;
                margin-right: 10px;
                cursor: pointer;
            }
        }

        .msg-back-btn {
            display: none;
        }
    </style>
    {% endif %}

    <link rel="icon" href="{{ url_for('static', filename='images/logos/logo.png') }}" type="image/png">

    <script nonce="{{ csp_nonce }}">
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-ZBED41BLPR');
    </script>

    <script nonce="{{ csp_nonce }}">
        function getCsrfToken() {
            const meta = document.querySelector('meta[name="csrf-token"]');
            return meta ? meta.getAttribute('content') : '';
        }
    </script>

    <style>
        /* GitHub Support Tooltip */
        .support-tooltip {
            position: relative;
        }

        .support-tooltip::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 8px;
            padding: 4px 8px;
            background: #eab308;
            /* Yellow/Gold for star */
            color: #0f172a;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 4px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            pointer-events: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .support-tooltip::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 4px;
            border: 4px solid transparent;
            border-top-color: #eab308;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }

        .support-tooltip:hover::before,
        .support-tooltip:hover::after {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-2px);
        }

        @keyframes heartbeat {
            0% {
                transform: scale(1);
            }

            14% {
                transform: scale(1.1);
                text-shadow: 0 0 10px rgba(251, 191, 36, 0.6);
            }

            28% {
                transform: scale(1);
            }

            42% {
                transform: scale(1.1);
                text-shadow: 0 0 10px rgba(251, 191, 36, 0.6);
            }

            70% {
                transform: scale(1);
            }
        }

        .github-pulse {
            color: #fbbf24 !important;
            /* Gold color */
            animation: heartbeat 3s infinite;
            display: inline-block;
        }

        .github-pulse:hover {
            animation: none;
            /* Stop pulsing on hover so tooltip is stable */
            text-shadow: 0 0 15px rgba(251, 191, 36, 0.8);
            transform: scale(1.1);
            transition: all 0.3s ease;
        }
    </style>
    {% block extra_head %}{% endblock %}
</head>

<body class="{% if no_default_styles %}no-default-styles{% endif %}">

    <header class="position-fixed fixed-top {% if no_default_styles %}custom-header{% endif %}"
        style="display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:15px;">

        <div style="display:flex;align-items:center;gap:15px;">
            <div class="logo-container">
                <a href="https://dockerlabs.es">
                    <img src="{{ url_for('static', filename='images/logos/logo.png') }}" alt="DockerLabs" width="60"
                        height="55">
                </a>
            </div>

            <div class="raiola-container">
                <a href="https://raiolanetworks.com/landing/hosting-...io/?utm_medium=affiliate&utm_source=5855&utm_campaign=Afiliados"
                    target="_blank">
                    <img src="{{ url_for('static', filename='images/raiola.png') }}" alt="Raiola Networks" width="290"
                        height="50">
                </a>
            </div>
        </div>

        <h1 style="margin:0;text-align:center;">
            <a href="{{ url_for('bunkerlabs.bunkerlabs_home') }}" id="dockerlabs-link"
                onmouseover="this.innerText='BunkerLabs'" onmouseout="this.innerText='DockerLabs'">
                DockerLabs
            </a>
        </h1>

        <div class="auth-buttons" style="justify-self:end;display:flex;gap:0.75rem;align-items:center;">
            <button type="button" onclick="openMenuModal()" class="btn-auth">
                <i class="bi bi-list"></i>
                Men√∫
            </button>

            {% if session.get('user_id') %}
            <button type="button" onclick="openMessagingModal()" class="btn-auth msg-btn">
                <i class="bi bi-envelope"></i>
                <span id="msg-badge" class="msg-badge">0</span>
            </button>

            <button type="button" onclick="openGestionWriteupsModal()" class="btn-auth">
                <i class="bi bi-file-text"></i>
                Gesti√≥n writeups
            </button>

            <button type="button" onclick="openDashboardModal()" class="btn-auth">
                <i class="bi bi-speedometer2"></i>
                Dashboard
            </button>

            <a href="{{ url_for('auth.logout') }}"><button class="btn-auth btn-logout">
                    <i class="bi bi-box-arrow-right"></i>
                    Cerrar sesi√≥n
                </button></a>
            {% else %}
            <button onclick="window.location.href='{{ url_for('auth.login') }}';" class="btn-auth">
                <i class="bi bi-box-arrow-in-right"></i>
                Iniciar sesi√≥n
            </button>
            <button onclick="window.location.href='{{ url_for('auth.register') }}';" class="btn-auth">
                <i class="bi bi-person-plus"></i>
                Registro
            </button>
            {% endif %}
        </div>

    </header>

    <div id="gestionWriteupsModal" class="overlay">
        <div class="popup" style="width: min(400px, 90%);">
            <button class="modal-close-button" type="button" onclick="closeGestionWriteupsModal()">&times;</button>
            <div class="modal-header">
                <h2 class="modal-title">Gesti√≥n writeups</h2>
            </div>
            <div class="ranking-list">
                <a href="{{ url_for('writeups.writeups_publicados') }}" class="ranking-item">
                    <div class="user-info">
                        <span class="user-name">Writeups publicados</span>
                    </div>
                    <i class="bi bi-chevron-right" style="color: #64748b;"></i>
                </a>
                {% if current_user_role in ['admin', 'moderador'] %}
                <a href="{{ url_for('writeups.writeups_recibidos') }}" class="ranking-item">
                    <div class="user-info">
                        <span class="user-name">Writeups recibidos</span>
                    </div>
                    <i class="bi bi-chevron-right" style="color: #64748b;"></i>
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <div id="menuModal" class="overlay">
        <div class="popup" style="width: min(400px, 90%);">
            <button class="modal-close-button" type="button" onclick="closeMenuModal()">&times;</button>
            <div class="modal-header">
                <h2 class="modal-title">Men√∫</h2>
            </div>
            <div class="ranking-list">
                <a href="https://app.secur0.com/vulnerability-disclosure/Dockerlabs" target="_blank"
                    class="ranking-item">
                    <div class="user-info"><span class="user-name">Programa VDP</span></div>
                    <i class="bi bi-box-arrow-up-right" style="color: #64748b; font-size: 0.9rem;"></i>
                </a>
                <a href="{{ url_for('main.instrucciones_uso') }}" target="_blank"
                    class="ranking-item">
                    <div class="user-info"><span class="user-name">Instrucciones de Uso</span></div>
                    <i class="bi bi-file-earmark-pdf" style="color: #64748b;"></i>
                </a>
                <a href="{{ url_for('main.enviar_maquina') }}" class="ranking-item">
                    <div class="user-info"><span class="user-name">Enviar M√°quina</span></div>
                    <i class="bi bi-chevron-right" style="color: #64748b;"></i>
                </a>
                <a href="{{ url_for('main.como_se_crea') }}" class="ranking-item">
                    <div class="user-info"><span class="user-name">C√≥mo se Crea una M√°quina</span></div>
                    <i class="bi bi-chevron-right" style="color: #64748b;"></i>
                </a>
                <a href="/docs/" target="_blank" class="ranking-item">
                    <div class="user-info"><span class="user-name">Swagger UI</span></div>
                    <i class="bi bi-file-code" style="color: #64748b;"></i>
                </a>
                <a href="{{ url_for('main.agradecimientos') }}" class="ranking-item">
                    <div class="user-info"><span class="user-name">Agradecimientos</span></div>
                    <i class="bi bi-heart" style="color: #64748b;"></i>
                </a>
            </div>
        </div>
    </div>

    <div id="dashboardModal" class="overlay">
        <div class="popup" style="width: min(400px, 90%);">
            <button class="modal-close-button" type="button" onclick="closeDashboardModal()">&times;</button>
            <div class="modal-header">
                <h2 class="modal-title">Dashboard</h2>
                <div class="modal-subtitle">Opciones de usuario</div>
            </div>
            <div class="ranking-list">
                <a href="{{ url_for('dashboard') }}" class="ranking-item">
                    <div class="user-info"><span class="user-name">Ir al Dashboard</span></div>
                    <i class="bi bi-speedometer2" style="color: #64748b;"></i>
                </a>
                <a href="{{ url_for('maquinas.maquinas_hechas') }}" class="ranking-item">
                    <div class="user-info"><span class="user-name">M√°quinas Completadas</span></div>
                    <i class="bi bi-check-circle" style="color: #64748b;"></i>
                </a>
                {% if current_user_role in ['admin', 'moderador'] %}
                <a href="{{ url_for('peticiones') }}" class="ranking-item">
                    <div class="user-info"><span class="user-name">Peticiones</span></div>
                    <i class="bi bi-inbox" style="color: #64748b;"></i>
                </a>
                <a href="{{ url_for('auth.gestion_usuarios') }}" class="ranking-item">
                    <div class="user-info"><span class="user-name">Gesti√≥n Usuarios</span></div>
                    <i class="bi bi-people" style="color: #64748b;"></i>
                </a>
                {% endif %}
                <a href="{{ url_for('maquinas.gestion_maquinas') }}" class="ranking-item">
                    <div class="user-info"><span class="user-name">Gesti√≥n M√°quinas</span></div>
                    <i class="bi bi-gear" style="color: #64748b;"></i>
                </a>
                {% if current_user_role == 'admin' %}
                <a href="{{ url_for('maquinas.add_maquina_page') }}" class="ranking-item">
                    <div class="user-info"><span class="user-name">A√±adir M√°quina</span></div>
                    <i class="bi bi-plus-lg" style="color: #64748b;"></i>
                </a>
                <a href="{{ url_for('bunkerlabs.accesos_bunkerlabs') }}" class="ranking-item">
                    <div class="user-info"><span class="user-name">Accesos Bunkerlabs</span></div>
                    <i class="bi bi-key" style="color: #64748b;"></i>
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Messaging Modal -->
    <div id="messagingModal" class="overlay">
        <div class="popup" style="width: min(800px, 95%); padding: 0; overflow: hidden; border-radius: 15px;">
            <div class="modal-header" style="padding: 1rem; border-bottom: 1px solid #334155; background: #0f172a;">
                <h2 class="modal-title" style="font-size: 1.25rem;">Mensajes</h2>
            </div>
            <div class="modal-body">
                <div class="msg-sidebar" id="msgSidebar">
                    <button class="msg-new-btn" onclick="showNewMessageInput()">
                        <i class="bi bi-pencil-square"></i> Nuevo Mensaje
                    </button>
                    {% if current_user_role == 'admin' %}
                    <button class="msg-new-btn" style="background: #eab308; margin-top: 0.5rem;"
                        onclick="showBroadcastInput()">
                        <i class="bi bi-megaphone"></i> Difusi√≥n
                    </button>
                    {% endif %}
                    <div id="msgNew" style="display:none; padding:1rem;">
                        <input type="text" id="newMsgUser" class="msg-input" placeholder="Buscar usuario..."
                            autocomplete="off">
                        <div id="searchResults" class="search-results"></div>
                        <button class="btn-auth"
                            style="padding: 0.5rem; margin-top:0.5rem; width:100%; background:#ef4444; color: #ffffff; font-weight: bold;"
                            onclick="cancelNewMessage()">Cancelar</button>
                    </div>
                    <div id="msgBroadcast" style="display:none; padding:1rem;">
                        <p style="color:#eab308; font-size:0.9rem; margin-bottom:0.5rem;">‚ö†Ô∏è Mensaje a TODOS los
                            usuarios</p>
                        <textarea id="broadcastContent" class="msg-input" rows="3"
                            placeholder="Escribe tu anuncio..."></textarea>
                        <button class="btn-auth"
                            style="padding: 0.5rem; margin-top:0.5rem; width:100%; background:#eab308; color: #000000; font-weight: bold;"
                            onclick="sendBroadcast()">Enviar Difusi√≥n</button>
                        <button class="btn-auth"
                            style="padding: 0.5rem; margin-top:0.5rem; width:100%; background:#ef4444; color: #ffffff; font-weight: bold;"
                            onclick="cancelBroadcast()">Cancelar</button>
                    </div>
                    <div class="msg-list" id="msgList">
                        <!-- Conversations go here -->
                        <div style="padding: 1rem; text-align: center; color: #94a3b8;">Cargando...</div>
                    </div>
                </div>
                <div class="msg-content" id="msgContent">
                    <div class="msg-chat-header"
                        style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; align-items:center;">
                            <i class="bi bi-arrow-left msg-back-btn" onclick="backToSidebar()"></i>
                            <span id="chatUserName">Selecciona un chat</span>
                        </div>
                        <i class="bi bi-trash" id="deleteChatBtn"
                            style="cursor:pointer; color:#ef4444; display:none; font-size:1.2rem;"
                            onclick="deleteCurrentChat()" title="Eliminar conversaci√≥n"></i>
                    </div>
                    <div class="msg-chat-messages" id="chatMessages">
                        <!-- Messages go here -->
                        <div
                            style="display: flex; height: 100%; align-items: center; justify-content: center; color: #64748b;">
                            <p>Selecciona una conversaci√≥n para empezar</p>
                        </div>
                    </div>
                    <div class="msg-input-area" id="inputArea" style="display:none;">
                        <input type="text" id="messageInput" class="msg-input" placeholder="Escribe un mensaje..."
                            onkeypress="handleEnter(event)">
                        <button class="msg-send-btn" onclick="sendMessage()"><i class="bi bi-send"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% block content %}{% endblock %}

    <footer class="{% if no_default_styles %}custom-footer{% endif %}">
        <div class="footer-content">
            <p class="copyright">
                <i class="bi bi-c-circle"></i> Copyright DockerLabs ¬∑
                <a href="{{ url_for('main.politica_privacidad') }}" class="footer-link">Pol√≠tica de Privacidad</a> ¬∑
                <a href="{{ url_for('main.politica_cookies') }}" class="footer-link">Cookies</a> ¬∑
                <a href="{{ url_for('main.condiciones_uso') }}" class="footer-link">Condiciones de Uso</a>
            </p>

            <div class="footer-icons">
                <a href="https://discord.gg/dD3yVejBUR" class="footer-icon" target="_blank"><i
                        class="bi bi-discord"></i></a>
                <a href="https://es.linkedin.com/in/maalfer1" class="footer-icon" target="_blank"><i
                        class="bi bi-linkedin"></i></a>
                <a href="https://t.me/elpinguinohack" class="footer-icon" target="_blank"><i
                        class="bi bi-telegram"></i></a>
                <a href="https://github.com/Maalfer/dockerlabs" class="footer-icon support-tooltip" target="_blank"
                    data-tooltip="¬øNos das una ‚≠ê?"><i class="bi bi-github github-pulse"></i></a>
            </div>

            <p>
                <a href="https://www.youtube.com/@ElPinguinoDeMario" class="footer-link" target="_blank">
                    By El Ping√ºino de Mario üêß
                </a>
            </p>
        </div>

        <div class="wave-container">
            <div class="wave wave1"></div>
            <div class="wave wave2"></div>
        </div>
    </footer>

    <script nonce="{{ csp_nonce }}">
        function openGestionWriteupsModal() { document.getElementById('gestionWriteupsModal').classList.add('visible'); }
        function closeGestionWriteupsModal() { document.getElementById('gestionWriteupsModal').classList.remove('visible'); }
        function openDashboardModal() { document.getElementById('dashboardModal').classList.add('visible'); }
        function closeDashboardModal() { document.getElementById('dashboardModal').classList.remove('visible'); }
        function openMenuModal() { document.getElementById('menuModal').classList.add('visible'); }
        function closeMenuModal() { document.getElementById('menuModal').classList.remove('visible'); }

        document.addEventListener('DOMContentLoaded', function () {

            const gestionModal = document.getElementById('gestionWriteupsModal');
            if (gestionModal) {
                gestionModal.addEventListener('click', function (e) {
                    if (e.target === gestionModal) closeGestionWriteupsModal();
                });
            }

            const dashboardModal = document.getElementById('dashboardModal');
            if (dashboardModal) {
                dashboardModal.addEventListener('click', function (e) {
                    if (e.target === dashboardModal) closeDashboardModal();
                });
            }

            const menuModal = document.getElementById('menuModal');
            if (menuModal) {
                menuModal.addEventListener('click', function (e) {
                    if (e.target === menuModal) closeMenuModal();
                });
            }

            // Mobile responsive link for DockerLabs title
            const dockerlabsLink = document.getElementById('dockerlabs-link');
            if (dockerlabsLink) {
                dockerlabsLink.addEventListener('click', function (event) {
                    const isMobile = window.innerWidth <= 768;

                    if (isMobile) {
                        // In mobile, prevent default and go to dockerlabs.es
                        event.preventDefault();
                        window.location.href = 'https://dockerlabs.es';
                    }
                    // In desktop, let the default href work (BunkerLabs)
                });

                // Remove hover effect in mobile
                function updateHoverEffect() {
                    const isMobile = window.innerWidth <= 768;

                    if (isMobile) {
                        dockerlabsLink.onmouseover = null;
                        dockerlabsLink.onmouseout = null;
                        dockerlabsLink.innerText = 'DockerLabs';
                    } else {
                        dockerlabsLink.onmouseover = function () { this.innerText = 'BunkerLabs'; };
                        dockerlabsLink.onmouseout = function () { this.innerText = 'DockerLabs'; };
                    }
                }

                updateHoverEffect();
                window.addEventListener('resize', updateHoverEffect);
            }

        });
    </script>

    {% if session.get('user_id') %}
    <script src="{{ url_for('static', filename='js/messaging.js') }}"></script>
    {% endif %}
    {% block scripts %}{% endblock %}
</body>

</html>