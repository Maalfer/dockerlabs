{% extends "dockerlabs/base.html" %}

{% block title %}Gestión de Usuarios - DockerLabs{% endblock %}

{% block extra_head %}
<style>
    /* Override body padding for this page */
    body {
        padding-left: 0 !important;
        padding-right: 0 !important;
    }

    /* Remove all width constraints and use full page width */
    .gestion-usuarios-container {
        width: 100% !important;
        max-width: 100% !important;
        margin: 0 !important;
        padding: 80px 10px 2rem 10px !important;
        box-sizing: border-box !important;
    }

    /* Ensure table uses full available width */
    .table-responsive {
        max-width: 100% !important;
        width: 100% !important;
        margin: 0 !important;
        overflow-x: auto !important;
    }

    /* Make table itself full width */
    #gestionUsuariosTable {
        width: 100% !important;
        margin: 0 !important;
        table-layout: auto !important;
    }

    /* Override h2 margins */
    .gestion-usuarios-container h2 {
        margin-left: 0 !important;
        margin-right: 0 !important;
    }

    /* Override Bootstrap container classes globally for this page */
    .container,
    .container-fluid,
    .container-sm,
    .container-md,
    .container-lg,
    .container-xl,
    .container-xxl {
        max-width: 100% !important;
        width: 100% !important;
        padding-left: 10px !important;
        padding-right: 10px !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="gestion-usuarios-container">
    <h2 class="mb-4">Gestión de Usuarios</h2>

    {% if usuarios|length == 0 %}
    <div class="alert alert-info">
        No hay usuarios registrados.
    </div>
    {% else %}

    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="input-group input-group-sm" style="max-width: 320px;">
            <span class="input-group-text bg-dark border-secondary text-muted">
                <i class="bi bi-search"></i>
            </span>
            <input type="text" id="userSearchInput"
                class="form-control form-control-sm bg-dark text-light border-secondary"
                placeholder="Buscar por usuario, email o rol..." autocomplete="off">
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-striped align-middle" id="gestionUsuariosTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>
                        Usuario
                        <button type="button" class="btn btn-sm btn-secondary ms-2" id="toggleUsersBtn"
                            onclick="toggleUsers()">
                            <i class="bi bi-eye" id="toggleUsersIcon"></i>
                        </button>
                    </th>
                    {% if current_user_role == 'admin' %}
                    <th>
                        Email
                        <button type="button" class="btn btn-sm btn-secondary ms-2" id="toggleEmailsBtn"
                            onclick="toggleEmails()">
                            <i class="bi bi-eye" id="toggleEmailsIcon"></i>
                        </button>
                    </th>
                    <th>PIN</th>
                    {% endif %}
                    <th>Rol</th>
                    <th>Creado</th>
                    {% if current_user_role == 'admin' %}
                    <th class="text-center">Acciones</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for usuario in usuarios %}
                <tr>
                    <td>{{ usuario.id }}</td>
                    <td class="user-cell" data-user="{{ usuario.username }}">
                        <span class="user-censored">***************</span>
                        <span class="user-real" style="display: none;">{{ usuario.username }}</span>
                    </td>
                    {% if current_user_role == 'admin' %}
                    <td class="email-cell" data-email="{{ usuario.email }}">
                        <span class="email-censored">***************</span>
                        <span class="email-real" style="display: none;">{{ usuario.email }}</span>
                    </td>
                    <td>
                        {% if usuario.recovery_pin_plain %}
                        <span class="badge bg-info text-dark">{{ usuario.recovery_pin_plain }}</span>
                        {% else %}
                        <span class="text-muted small">N/A</span>
                        {% endif %}
                    </td>
                    {% endif %}
                    <td>
                        {% if current_user_role == 'admin' %}
                        <form method="post" action="{{ url_for('auth.update_user_role', user_id=usuario.id) }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <select name="role" class="form-select form-select-sm" onchange="this.form.submit()">
                                <option value="jugador" {% if usuario.role=='jugador' %}selected{% endif %}>Jugador
                                </option>
                                <option value="moderador" {% if usuario.role=='moderador' %}selected{% endif %}>
                                    Moderador</option>
                                <option value="admin" {% if usuario.role=='admin' %}selected{% endif %}>Admin</option>
                            </select>
                        </form>
                        {% else %}
                        <span class="badge bg-secondary">{{ usuario.role|capitalize }}</span>
                        {% endif %}
                    </td>

                    <td>{{ usuario.created_at }}</td>

                    {% if current_user_role == 'admin' %}
                    <td class="text-center">
                        <form method="post" action="{{ url_for('auth.delete_user', user_id=usuario.id) }}"
                            onsubmit="return confirm('¿Seguro que quieres eliminar este usuario?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-sm btn-danger">
                                Eliminar
                            </button>
                        </form>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>

    </div>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const input = document.getElementById('userSearchInput');
        const table = document.getElementById('gestionUsuariosTable');
        if (!input || !table) return;

        const rows = Array.from(table.querySelectorAll('tbody tr'));

        function filtrarUsuarios() {
            const term = input.value.trim().toLowerCase();

            rows.forEach((tr) => {
                const text = tr.innerText.toLowerCase();
                if (!term || text.includes(term)) {
                    tr.style.display = '';
                } else {
                    tr.style.display = 'none';
                }
            });
        }

        input.addEventListener('input', filtrarUsuarios);
    });

    // Toggle email visibility
    let emailsVisible = false;

    function toggleEmails() {
        emailsVisible = !emailsVisible;
        const censoredSpans = document.querySelectorAll('.email-censored');
        const realSpans = document.querySelectorAll('.email-real');
        const icon = document.getElementById('toggleEmailsIcon');

        censoredSpans.forEach(span => {
            span.style.display = emailsVisible ? 'none' : 'inline';
        });

        realSpans.forEach(span => {
            span.style.display = emailsVisible ? 'inline' : 'none';
        });

        // Update icon
        if (emailsVisible) {
            icon.className = 'bi bi-eye-slash';
        } else {
            icon.className = 'bi bi-eye';
        }
    }

    // Toggle user visibility
    let usersVisible = false;

    function toggleUsers() {
        usersVisible = !usersVisible;
        const censoredSpans = document.querySelectorAll('.user-censored');
        const realSpans = document.querySelectorAll('.user-real');
        const icon = document.getElementById('toggleUsersIcon');

        censoredSpans.forEach(span => {
            span.style.display = usersVisible ? 'none' : 'inline';
        });

        realSpans.forEach(span => {
            span.style.display = usersVisible ? 'inline' : 'none';
        });

        // Update icon
        if (usersVisible) {
            icon.className = 'bi bi-eye-slash';
        } else {
            icon.className = 'bi bi-eye';
        }
    }
</script>
{% endblock %}